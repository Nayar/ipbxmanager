<script src="/assets/js/vue.js"></script>
<script src="/assets/js/vue-router.js"></script>
<title>IPBX</title>
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
<script>
	var vm;
	var companies = []
	
	company_add_form = Vue.component('company-add-form', {
		data: function () {
			return {
				custom_domain: 'no',
				domain : '',
				company_name: '',
				company_brn: '',
				contact_email: '',
				contact_name: '',
				contact_position: '',
				company_website: ''
			}
		},
		watch: {
				company_name: function(old,newd) {
					this.domain = this.company_name.replace(/\s+/g, '-').toLowerCase();
				}
		},
		methods: {
			place_order: function (event) {
					//alert('wow')
					console.log(event)
					var ziss=this
					console.log(ziss)
					frappe.call({
						method:"ipbxmanager.api.add_company",
						args: ziss.$data,
						callback: function(r) { 
							console.log(r);
							if(r.message == true){
								alert('Order placed');
							}
						}
					})
				}
		},
		template: '<form id="form1">\
	<div class="form-group has-success has-feedback">\
		<label>Enter your Name</label>\
		<input type="text" class="form-control" v-model="contact_name" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="Your Name">\
	</div>\
	\
	<div class="form-group has-success has-feedback">\
		<label>Your Email Address</label>\
		<input type="email" class="form-control" v-model="contact_email" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="Email">\
	</div>\
	\
	<div class="form-group has-success has-feedback">\
		<label>Enter your Company Name</label>\
		<input type="text" class="form-control" v-model="company_name" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="Company Name">\
	</div>\
	\
	<div class="form-group has-success has-feedback">\
		<label>Enter your Company BRN</label>\
		<input type="text" class="form-control" v-model="company_brn" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="Company BRN">\
	</div>\
	\
	<div class="form-group has-success has-feedback">\
		<label>Your position at the company</label>\
		<input type="text" class="form-control" v-model="contact_position" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="Your position at the company">\
	</div>\
	\
	<div class="form-group has-success has-feedback">\
		<label>Company Website</label>\
		<input type="text" class="form-control" v-model="company_website" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="Your position at the company">\
	</div>\
\
	<div>\
		<label>Do you wish to use your own domain name?</label>\
		<div class="radio">\
			<label><input type="radio" name="customdomain" v-model="custom_domain" value="no" id="no">No</label>\
		</div>\
		<div class="radio">\
			<label><input type="radio" name="customdomain" v-model="custom_domain" value="yes" id="yes">Yes</label>\
		</div>\
		\
	</div>\
	\
	<label>Choose your domain name</label>\
	<div class="form-group has-success has-feedback" v-if=\'custom_domain == "yes"\'>\
		<label class="control-label sr-only" for="inputSuccess5">Hidden label</label>\
		<input type="text" class="form-control" v-model="domain" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="yourcompany.com">\
		<span v-if=\'domain != ""\'>\
		<br/>\
		Please point {{domain}} to our name servers as follows:\
		<br/>\
			<code>\
			{{domain}}. IN NS ns1.joolfoo.com\
			</code>\
		</span>\
	</div>\
	\
	<div class="form-group has-success" v-if=\'custom_domain == "no"\'>\
		<label class="control-label sr-only" for="inputGroupSuccess4">Input group with success</label>\
		<div class="input-group">\
			<input type="text" class="form-control" id="inputGroupSuccess4" aria-describedby="inputGroupSuccess4Status" v-model="domain" placeholder="yourcompany">\
			<span class="input-group-addon" >.pbx.jooolfoo.com</span>\
		</div>\
		<span id="inputGroupSuccess4Status" class="sr-only">(success)</span>\
	</div>\
	\
\
	<div class="text-center">\
		<button type="button" class="btn btn-default btn-primary" aria-label="Left Align" @click="place_order">Place Order</button>\
	</div>\
\
</form>'
	})
	
	Vue.component('view-company', {
		props : ['company'],
		template: '<div>\
		<div>\
			<div><br/><table class="table table-striped">\
			<tbody>\
				<tr>\
					<td>\
						Package\
					</td>\
					<td>\
						Free Trial <button class="btn btn-primary">Upgrade</button>\
					</td>\
				</tr>\
				<tr>\
					<td>\
						No of SIP Accounts\
					</td>\
					<td>\
						2/5\
					</td>\
				</tr>\
				<tr>\
					<td>\
						SIP Domain\
					</td>\
					<td>\
						{% raw %}{{company.name}}{% endraw %}\
					</td>\
				</tr>\
				<tr>\
					<td>\
						Company Name\
					</td>\
					<td>\
						{% raw %}{{company.company_name}}{% endraw %}\
					</td>\
				</tr>\
				<tr><td>Company BRN</td><td>{% raw %}{{company.company_brn}}{% endraw %}</td></tr>\
				<tr><td>Contact Name</td><td>{% raw %}{{company.contact_name}}{% endraw %}</td></tr>\
				<tr><td>Contact Email</td><td>{% raw %}{{company.contact_email}}{% endraw %}</td></tr>\
				<tr><td>Contact Telephone</td><td>{% raw %}{{company.contact_tel}}{% endraw %}</td></tr>\
			</tbody>\
			</table>\
</div>\
			</div>\
		</div>'
	})
	
	Vue.component('user-add-modal', {
		data: function() {
			return {
				start_id: 1000,
				end_id: 1001,
				groups: []
			}
		},
		created () {
				ziss = this
				frappe.call({
					method:"ipbxmanager.api.get_groups",
					type: 'GET',
					args: {
						company_name: this.$route.params.id
					},
					callback: function(r) { 
						console.log(r);
						ziss.groups = r.message
					}
				})
		},
		template: '<!-- Modal -->\
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">\
  <div class="modal-dialog" role="document">\
    <div class="modal-content">\
      <div class="modal-header">\
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
        <h4 class="modal-title" id="myModalLabel">Add Users</h4>\
      </div>\
      <div class="modal-body">\
				<div class="form-group has-success has-feedback">\
					<label>Start User ID</label>\
					<input type="text" class="form-control" v-model="start_id" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="">\
				</div>\
				<div class="form-group has-success has-feedback">\
					<label>End User ID</label>\
					<input type="text" class="form-control" v-model="end_id" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="">\
				</div>\
				<div class="form-group has-success has-feedback">\
					<label>Groups</label>\
					<ul><li v-for="group in groups">\
						{% raw %}{{ group.group_name }} ({{ group.sip_extension }}){% endraw %} <input type="checkbox" name="groups[]" v-bind:value="group.name"/>\
					</li></ul>\
				</div>\
      </div>\
      <div class="modal-footer">\
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
        <button type="button" class="btn btn-primary">Save changes</button>\
      </div>\
    </div>\
  </div>\
</div>'
	})
	
		Vue.component('group-add-modal', {
		data: function() {
			return {
				group_name: '',
				sip_extension: ''
			}
		},
		methods: {
			add_group: function() {
				console.log(event)
					var ziss=this
					console.log(ziss)
					frappe.call({
						method:"ipbxmanager.api.add_group",
						args: {
							sip_domain: this.$route.params.id,
							group_name: ziss.group_name,
							sip_extension: ziss.sip_extension
						},
						callback: function(r) { 
							console.log(r);
							if(r.message == true || r.message.hasOwnProperty('name')){
								alert('Group added');
							}
						}
					})
			}
		},
		template: '<!-- Modal -->\
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">\
  <div class="modal-dialog" role="document">\
    <div class="modal-content">\
      <div class="modal-header">\
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>\
        <h4 class="modal-title" id="myModalLabel">Add Group</h4>\
      </div>\
      <div class="modal-body">\
				<div class="form-group has-success has-feedback">\
					<label>Group Name</label>\
					<input type="text" class="form-control" v-model="group_name" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="">\
				</div>\
				<div class="form-group has-success has-feedback">\
					<label>Extension</label>\
					<input type="text" class="form-control" v-model="sip_extension" id="inputSuccess5" aria-describedby="inputSuccess5Status" placeholder="">\
				</div>\
      </div>\
      <div class="modal-footer">\
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>\
        <button type="button" class="btn btn-primary" @click="add_group">Save changes</button>\
      </div>\
    </div>\
  </div>\
</div>'
	})
	
	Vue.component('list-company', {
		props: ['company'],
		template: '<div>\
			<h1>{% raw %}{{company.name}}{% endraw %}</h1>\
			<ul class="nav nav-tabs">\
						<li><router-link v-bind:to="\'/\' + company.name"><span class="glyphicon glyphicon-info-sign"> Company Details </span></router-link></li>\
						<li><router-link v-bind:to="\'/\' + company.name + \'/users\'"><span class="glyphicon glyphicon-user"> Users </span></router-link></li>\
						<li><router-link v-bind:to="\'/\' + company.name + \'/groups\'"><span class="glyphicon glyphicon-list-alt"> Groups </span></router-link></li>\
						<li><router-link v-bind:to="\'/\' + company.name + \'/ivrs\'"><span class="glyphicon glyphicon-random">  IVR </span></router-link></li>\
						<li><router-link v-bind:to="\'/\' + company.name + \'/settings\'"><span class="glyphicon glyphicon-cog"> Settings </span></router-link></li>\
					</ul>\
				</nav>\
			<router-view></router-view>\
			<view-company v-bind:company="company" v-if="$route.path.match(/^\\/[^\\/]*$/)"></view-company>\
		</div>'
	})
	
	Vue.component('list-companies', {
		props: ['companies'],
		template: '<div><br/><table class="table table-striped">\
			<thead>\
				<tr>\
					<th>SIP Domain</th>\
					<th>Company Name</th>\
					<th>Company BRN</th>\
					<th>Contact Details</th>\
					<th>Status</th>\
					<th>Actions</th>\
				</tr>\
			</thead>\
			<tbody>\
				<tr v-for="company in companies">\
					<td>{% raw %}{{company.name}}{% endraw %}</td>\
					<td>{% raw %}{{company.company_name}}{% endraw %}</td>\
					<td>{% raw %}{{company.company_brn}}{% endraw %}</td>\
					<td>{% raw %}{{company.contact_name}}<br/>{{company.contact_email}}<br/>{{company.contact_tel}}{% endraw %}</td>\
					<td>{% raw %}Active{% endraw %}</td>\
					<td> <router-link v-bind:to="\'/\' + company.name"><button class="btn btn-primary"><span class="glyphicon glyphicon-cog"></span></button></router-link></td>\
				</tr>\
			</tbody>\
			</table><center><router-link to="/order"><span class="btn btn-success"><span class="glyphicon glyphicon-plus"></span></span></router-link></center></div>'
	})
	
	window.onload = function() {
	
		const ListIPBX = { 	
			template: '<list-companies v-bind:companies="companies"></list-companies>',
			data () {
				return {
					companies: []
				}
			},
			created () {
				ziss = this
				frappe.call({
					method:"ipbxmanager.api.get_companies",
					type: 'GET',
					callback: function(r) { 
						console.log(r);
						ziss.companies = r.message
					}
				})
			}
		}
		const SingleIPBX = { 
			template: '<list-company v-if="loaded" v-bind:company="company"></list-company>',
			data () {
					return {
						company: {},
						loaded: false
					}
				},
				created () {
					ziss = this
					frappe.call({
						method:"ipbxmanager.api.get_company",
						args: {
							company_name: this.$route.params.id
						},
						type: 'GET',
						callback: function(r) { 
							console.log(r);
							ziss.company = r.message
							ziss.loaded = true
						}
					})
			}
		}
		
		const UserList = {
			template: '<div>\
			<div><br/><table class="table table-striped">\
			<thead>\
				<tr>\
					<th>User ID</th>\
					<th>Extension</th>\
					<th>Actions</th>\
				</tr>\
			</thead>\
			<tbody>\
				<tr v-for="user in users">\
					<td>{% raw %}{{user.name}}{% endraw %}</td>\
					<td>{% raw %}{{user.sip_user_id}}{% endraw %}</td>\
					<td>\
						<!--<button class="btn btn-primary"><span class="glyphicon glyphicon-cog"></span></button>-->\
						<button class="btn btn-danger" @click="delete_user(user.name)"><span class="glyphicon glyphicon glyphicon-minus"></span></button>\
					</td>\
				</tr>\
			</tbody>\
			</table><center><a href="#" class="btn btn-primary" data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-plus"></span></a></center>\
			<!-- Button trigger modal -->\
			<user-add-modal></user-add-modal>\
</div>\
			</div>',
			data () {
					return {
						users: []
					}
				},
				created () {
					var ziss = this
					frappe.call({
						method:"ipbxmanager.api.get_users",
						args: {
							company_name: this.$route.params.id
						},
						type: 'GET',
						callback: function(r) { 
							console.log(r);
							ziss.users = r.message
						}
					})
			},
			methods: {
				delete_user: function(name) {
					//alert(name)
					frappe.call({
						method:"ipbxmanager.api.delete_sip_user",
						args: {
							company_name: this.$route.params.id,
							sip_user: name
						},
						type: 'DELETE',
						callback: function(r) { 
							console.log(r)
							alert('User deleted')
						}
					})
				}
			}
		}
		
		const GroupList = {
			template: '<div>\
			<div><br/><table class="table table-striped">\
			<thead>\
				<tr>\
					<th>Group ID</th>\
					<th>Extension</th>\
					<th>Actions</th>\
				</tr>\
			</thead>\
			<tbody>\
				<tr v-for="item in groups">\
					<td>{% raw %}{{item.name}}{% endraw %}</td>\
					<td>{% raw %}{{item.group_name}}{% endraw %}</td>\
					<td>{% raw %}{{item.sip_extension}}{% endraw %}</td>\
					<td>\
						<!--<button class="btn btn-primary"><span class="glyphicon glyphicon-cog"></span></button>-->\
						<button class="btn btn-danger" @click="delete_user(user.name)"><span class="glyphicon glyphicon glyphicon-minus"></span></button>\
					</td>\
				</tr>\
			</tbody>\
			</table><center><a href="#" class="btn btn-primary" data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-plus"></span></a></center>\
			<!-- Button trigger modal -->\
			<group-add-modal></group-add-modal>\
</div>\
			</div>',
			data () {
					return {
						groups: []
					}
				},
				created () {
					var ziss = this
					frappe.call({
						method:"ipbxmanager.api.get_groups",
						args: {
							company_name: this.$route.params.id
						},
						type: 'GET',
						callback: function(r) { 
							console.log(r);
							ziss.groups = r.message
						}
					})
			},
			methods: {
				delete_group: function(name) {
					//alert(name)
					frappe.call({
						method:"ipbxmanager.api.delete_sip_group",
						args: {
							company_name: this.$route.params.id,
							sip_group: name
						},
						type: 'DELETE',
						callback: function(r) { 
							console.log(r)
							alert('Group deleted')
						}
					})
				}
			}
		}

		// 2. Define some routes
		// Each route should map to a component. The "component" can
		// either be an actual component constructor created via
		// `Vue.extend()`, or just a component options object.
		// We'll talk about nested routes later.
		
// 		, redirect: to => { 
// 				const { hash, params, query } = to
// 				return '/'+params.id+'/details'}
		
		const routes = [
			{ path: '/', component: ListIPBX,meta: {title: 'IPBX'}
			},
			{ path: '/order', component: company_add_form
			},
			{ path: '/:id', component: SingleIPBX,
				children: [
					{
						path: 'users',
						component: UserList
					},
					{
						path: 'groups',
						component: GroupList
					},
					{
						path: 'details',
						component: GroupList
					}
				]
			}
		]

		// 3. Create the router instance and pass the `routes` option
		// You can pass in additional options here, but let's
		// keep it simple for now.
		const router = new VueRouter({
		routes // short for `routes: routes`
		})

		// 4. Create and mount the root instance.
		// Make sure to inject the router with the router option to make the
		// whole app router-aware.
		vm = new Vue({
			router,
			data: {companies: companies}
		}).$mount('#app')
	}
</script>

<div class="page-container" id="app" 
   data-path="website-with-sidebar" data-doctype="Web Page">
  <div class="sidebar-block">
    <div class="web-sidebar">
      <div class="sidebar-items">
        <ul class="list-unstyled">	
            <li>
							<router-link to="/order">Order IPBX</router-link>
						</li>	
						<li>
							<router-link to="/">View IPBX Services</router-link>
						</li>
            <li class="sidebar-item">
              <a href="/me">My Account</a>
            </li>	
          </ul>
        </div>
      </div> 
    </div>
    <div class="page-content with-sidebar">
      <div class="page-content-wrapper">
        <div class="row page-head">
          <div class='col-sm-12'></div>
							<div>
								<router-view></router-view>
							</div>
          </div>
        </div>
      </div>
      <!-- sidebar ends -->
    </div>
  </div>
</div> 
